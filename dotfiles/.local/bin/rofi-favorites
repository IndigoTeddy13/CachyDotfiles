#! /usr/bin/env bash

# Source: https://github.com/luiscrjunior/rofi-favorites
CONFIG="$HOME/.config/plasma-org.kde.plasma.desktop-appletsrc"
SEARCH_DIRS=(
    "/usr/share/applications"
    "$HOME/.local/share/applications"
    "/var/lib/flatpak/exports/share/applications"
    "$HOME/Desktop"
)

# Retrieve list of favorites from KDE Plasma
raw_launcher_paths=$(awk -F= '/^\[Containments\]\[[0-9]+\]\[Applets\]\[[0-9]+\]\[Configuration\]\[General\]/ { in_section=1 } in_section && /^launchers=/ { print $2; exit }' "$CONFIG")

# Strip out the `file://` prefix, and store paths in a Bash array
# IFS (Internal Field Separator)
IFS=',' read -ra paths <<< "${raw_launcher_paths//file:\/\//}"

# Aggregate the proper paths of the favrote apps into a Bash array
favorites=()
for path in "${paths[@]}"; do
    if [[ "$path" == applications:* ]]; then
        file="${path#applications:}"
        # Check through each search dir until resolution
        for dir in "${SEARCH_DIRS[@]}"; do
            if [[ -f "$dir/$file" ]]; then
            # If full filepath resolves, append to proper list
                favorites+=("$dir/$file")
                break
            fi
        done
    else
        [[ -f "$path" ]] && favorites+=("$path")
    fi
done
# Total count, pad size
total=${#favorites[@]}
pad=${#total} # Number of digits

# On app selection in Rofi
if [ $# -eq 1 ]; then
    # Extract the name by removing the index prefix (ie:"01/10 | ")
    input_name="${1#* | }"

    for fav in "${favorites[@]}"; do
        # Extract using read and IFS
        while IFS='=' read -r key value; do
            [[ "$key" == "Name" ]] && name="$value"
            [[ "$key" == "Exec" ]] && exec_cmd="$value"
            [[ "$name" && "$exec_cmd" ]] && break
        done < "$fav"

        if [[ "$name" == "$input_name" ]]; then
            # gtk-launch launches the desktop file directly
            gtk-launch "$(basename "$fav")" >/dev/null 2>&1 &
            exit 0
        fi
        unset name exec_cmd
    done
    exit 1
fi

# Rofi List Display Generation
# Iterate directly over the favorites list
i=1
for fav in "${favorites[@]}"; do
    # Extract Name and Icon using a fast internal while loop instead of 3x awk
    unset name icon
    while IFS='=' read -r key value; do
        case "$key" in
            Name) name="$value" ;;
            Icon) icon="$value" ;;
        esac
        [[ -n "$name" && -n "$icon" ]] && break
    done < "$fav"

    printf "%0${pad}d/%0${pad}d | %s\0icon\x1f%s\n" "$i" "$total" "$name" "$icon"
    ((i++))
done
