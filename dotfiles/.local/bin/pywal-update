#!/usr/bin/bash

# Start by fixing the path by running bashrc
source $HOME/.bashrc

# Run Pywal depending on DE in use:
# GNOME:
if [ "$XDG_CURRENT_DESKTOP" == "GNOME" ]; then
    dbus-monitor "interface='org.freedesktop.DBus.Properties',member='PropertiesChanged'" |
    while read -r line; do
        if echo "$line" | grep -q "org.gnome.desktop.background"; then
            WALLPAPER_PATH=$(gsettings get org.gnome.desktop.background picture-uri-dark | awk -F"'" '{print $2}' | sed 's|file://||')
            magick "$WALLPAPER_PATH" -colorspace sRGB /tmp/wall.png
            wal --cols16 darken -n -i /tmp/wall.png
        fi
    done
fi
# KDE Plasma
if [ "$XDG_CURRENT_DESKTOP" == "KDE" ]; then
    dbus-monitor "interface='org.kde.plasmashell'" | while read -r line; do
        if echo "$line" | grep -q "org.kde.PlasmaShell.evaluateScript"; then
            WALLPAPER_PATH="$(get-kde-wallpaper)contents/images_dark/1080x1920.png"
            wal --cols16 darken -n -i "$WALLPAPER_PATH"
        fi
    done
fi